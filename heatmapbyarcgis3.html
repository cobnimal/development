<html>
<head>
  <meta charset='utf-8' />
  <title>ArcGIS Heatmap</title>
  <meta name='viewport' content='initial-scale=1, maximum-scale=1, user-scalable=no' />
  <link rel='stylesheet' href='https://js.arcgis.com/4.29/esri/themes/light/main.css' />
  <script src='https://js.arcgis.com/4.29/'></script>
  <style>
    html, body, #viewDiv { height: 100%; width: 100%; margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id='viewDiv'></div>
  <script>
    // Parse 'data' from URL (JSON-encoded)
    function getDataFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const raw = params.get("data");
      if (!raw) return [];

      try {
        const decoded = decodeURIComponent(raw);
        return JSON.parse(decoded);
      } catch (e) {
        console.error("Invalid 'data' parameter", e);
        return [];
      }
    }

    const data = getDataFromUrl();

    require(["esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer", "esri/Graphic", "esri/geometry/geometryEngine"], 
      function (Map, MapView, FeatureLayer, Graphic, geometryEngine) {
      
      const map = new Map({
        basemap: "streets-night-vector"
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-79.7596, 43.6850],
        zoom: 14
      });

      // Create graphics from data with ObjectID and weight attributes
      const graphics = data.map(function (item, index) {
        return new Graphic({
          geometry: {
            type: "point",
            y: item.lat,
            x: item.lon
          },
          attributes: {
            ObjectID: index + 1,
            weight: item.weight || 1
          }
        });
      });

      const heatmapLayer = new FeatureLayer({
        source: graphics,
        objectIdField: "ObjectID",
        fields: [
          { name: "ObjectID", type: "oid" },
          { name: "weight", type: "double" }
        ],
        geometryType: "point",
        spatialReference: { wkid: 4326 },
        renderer: {
          type: "heatmap",
          field: "weight",
          colorStops: [
            { ratio: 0, color: "rgba(255,255,255,0)" },
            { ratio: 0.2, color: "cyan" },
            { ratio: 0.5, color: "blue" },
            { ratio: 0.8, color: "red" },
            { ratio: 1, color: "yellow" }
          ],
          maxPixelIntensity: 10,
          minPixelIntensity: 0
        }
      });

      map.add(heatmapLayer);

      // Click event on view to find nearest graphic and show popup with details
      view.on("click", function(event) {
        const clickPoint = event.mapPoint;

        // Define a search distance in map units (~meters in WebMercator)
        const searchDistance = 50; // Adjust if needed

        // Buffer the click point
        const buffer = geometryEngine.geodesicBuffer(clickPoint, searchDistance, "meters");

        // Find graphics within the buffer
        const nearbyGraphics = graphics.filter(graphic => {
          return geometryEngine.intersects(graphic.geometry, buffer);
        });

        if (nearbyGraphics.length > 0) {
          // If multiple found, pick the closest
          nearbyGraphics.sort((a, b) => {
            const distA = geometryEngine.distance(clickPoint, a.geometry, "meters");
            const distB = geometryEngine.distance(clickPoint, b.geometry, "meters");
            return distA - distB;
          });

          const nearestGraphic = nearbyGraphics[0];
          const geom = nearestGraphic.geometry;
          const lat = geom.latitude || geom.y;
          const lon = geom.longitude || geom.x;
          const weight = nearestGraphic.attributes.weight;

          // Show popup at clicked location with info
          view.popup.open({
            title: "Heatmap Point Info",
            location: clickPoint,
            content: `
              <b>Latitude:</b> ${lat.toFixed(6)}<br/>
              <b>Longitude:</b> ${lon.toFixed(6)}<br/>
              <b>Weight:</b> ${weight}
            `
          });
        } else {
          view.popup.close();
        }
      });

    });
  </script>
</body>
</html>
