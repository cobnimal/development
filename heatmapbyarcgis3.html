<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ArcGIS Heatmap with Hover Popup</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.29/"></script>
    <style>
      html, body, #viewDiv {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="viewDiv"></div>
    <script>
      function getDataFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const raw = params.get("data");
        if (!raw) return [];

        try {
          return JSON.parse(decodeURIComponent(raw));
        } catch (e) {
          console.error("Invalid 'data' parameter", e);
          return [];
        }
      }

      const data = getDataFromUrl();

      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/Graphic"
      ], function(Map, MapView, FeatureLayer, Graphic) {

        // Create separate graphic arrays
        const heatmapGraphics = data.map((item, index) => {
          return new Graphic({
            geometry: {
              type: "point",
              longitude: item.lon,
              latitude: item.lat,
              spatialReference: { wkid: 4326 }
            },
            attributes: {
              ObjectID: index + 1,
              latitude: item.lat,
              longitude: item.lon,
              weight: item.weight || 1
            }
          });
        });

        const hoverGraphics = data.map((item, index) => {
          return new Graphic({
            geometry: {
              type: "point",
              longitude: item.lon,
              latitude: item.lat,
              spatialReference: { wkid: 4326 }
            },
            attributes: {
              ObjectID: index + 1,
              latitude: item.lat,
              longitude: item.lon,
              weight: item.weight || 1
            }
          });
        });

        const fields = [
          { name: "ObjectID", type: "oid" },
          { name: "latitude", type: "double" },
          { name: "longitude", type: "double" },
          { name: "weight", type: "double" }
        ];

        const heatmapLayer = new FeatureLayer({
          source: heatmapGraphics,
          fields: fields,
          objectIdField: "ObjectID",
          geometryType: "point",
          spatialReference: { wkid: 4326 },
          renderer: {
            type: "heatmap",
            field: "weight"
          }
        });

        const transparentPointLayer = new FeatureLayer({
          source: hoverGraphics,
          fields: fields,
          objectIdField: "ObjectID",
          geometryType: "point",
          spatialReference: { wkid: 4326 },
          renderer: {
            type: "simple",
            symbol: {
              type: "simple-marker",
              color: [255, 255, 255, 0.01], // invisible
              size: 20,
              outline: null
            }
          }
        });

        const map = new Map({
          basemap: "streets-night-vector",
          layers: [heatmapLayer, transparentPointLayer]
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-79.75, 43.69],
          zoom: 13
        });

        view.when(() => {
          view.whenLayerView(transparentPointLayer).then(() => {
            let lastId = null;

            view.on("pointer-move", (event) => {
              view.hitTest(event).then((response) => {
                const result = response.results.find(
                  (r) => r.graphic?.layer === transparentPointLayer
                );

                if (result && result.graphic.attributes.ObjectID !== lastId) {
                  lastId = result.graphic.attributes.ObjectID;
                  const attrs = result.graphic.attributes;

                  view.popup.open({
                    location: result.mapPoint,
                    title: "Point Details",
                    content: `
                      <b>Latitude:</b> ${attrs.latitude}<br/>
                      <b>Longitude:</b> ${attrs.longitude}<br/>
                      <b>Weight:</b> ${attrs.weight}
                    `
                  });
                } else if (!result) {
                  view.popup.close();
                  lastId = null;
                }
              });
            });
          });
        });
      });
    </script>
  </body>
</html>
