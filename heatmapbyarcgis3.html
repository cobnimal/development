<html>
<head>
  <meta charset='utf-8' />
  <title>ArcGIS Heatmap</title>
  <meta name='viewport' content='initial-scale=1, maximum-scale=1, user-scalable=no' />
  <link rel='stylesheet' href='https://js.arcgis.com/4.29/esri/themes/light/main.css' />
  <script src='https://js.arcgis.com/4.29/'></script>
  <style>
    html, body, #viewDiv { height: 100%; width: 100%; margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id='viewDiv'></div>
  <script>
    // Parse 'data' from URL (JSON-encoded)
    function getDataFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const raw = params.get("data");
      if (!raw) return [];

      try {
        const decoded = decodeURIComponent(raw);
        return JSON.parse(decoded);
      } catch (e) {
        console.error("Invalid 'data' parameter", e);
        return [];
      }
    }

    const data = getDataFromUrl();

    require(["esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer", "esri/Graphic"], 
  function (Map, MapView, FeatureLayer, Graphic) {
  
  const map = new Map({
    basemap: "streets-night-vector"
  });

  const view = new MapView({
    container: "viewDiv",
    map: map,
    center: [-79.7596, 43.6850],
    zoom: 14
  });

  const graphics = data.map(function (item, index) {
    return new Graphic({
      geometry: {
        type: "point",
        y: item.lat,
        x: item.lon
      },
      attributes: {
        ObjectID: index + 1,
        weight: item.weight || 1
      }
    });
  });

  // Heatmap layer for visualization
  const heatmapLayer = new FeatureLayer({
    source: graphics,
    objectIdField: "ObjectID",
    fields: [
      { name: "ObjectID", type: "oid" },
      { name: "weight", type: "double" }
    ],
    geometryType: "point",
    spatialReference: { wkid: 4326 },
    renderer: {
      type: "heatmap",
      field: "weight",
      colorStops: [
        { ratio: 0, color: "rgba(255,255,255,0)" },
        { ratio: 0.2, color: "cyan" },
        { ratio: 0.5, color: "blue" },
        { ratio: 0.8, color: "red" },
        { ratio: 1, color: "yellow" }
      ],
      maxPixelIntensity: 10,
      minPixelIntensity: 0
    }
  });

  // Transparent point layer on top for hit-testing and popup
  const pointLayer = new FeatureLayer({
    source: graphics,
    objectIdField: "ObjectID",
    fields: [
      { name: "ObjectID", type: "oid" },
      { name: "weight", type: "double" }
    ],
    geometryType: "point",
    spatialReference: { wkid: 4326 },
    renderer: {
      type: "simple",
      symbol: {
        type: "simple-marker",
        size: 0.1,  // very small marker, almost invisible
        color: [0, 0, 0, 0] // fully transparent
      }
    },
    // Enable hit testing for popup on this layer
    popupTemplate: {
      title: "Point Details",
      content: (feature) => {
        const lat = feature.geometry.latitude || feature.geometry.y;
        const lon = feature.geometry.longitude || feature.geometry.x;
        return `
          <b>Latitude:</b> ${lat.toFixed(6)}<br/>
          <b>Longitude:</b> ${lon.toFixed(6)}<br/>
          <b>Weight:</b> ${feature.attributes.weight}
        `;
      }
    }
  });

  map.add(heatmapLayer);
  map.add(pointLayer);

  // Click handler - use hitTest on the pointLayer to find clicked points
  view.on("click", function(event) {
    view.hitTest(event).then(function(response) {
      const results = response.results.filter(result => {
        // Filter for graphics from pointLayer only
        return result.graphic.layer === pointLayer;
      });

      if (results.length > 0) {
        // Show popup on first hit
        view.popup.open({
          location: event.mapPoint,
          features: [results[0].graphic]
        });
      } else {
        view.popup.close();
      }
    });
  });

});
  </script>
</body>
</html>
